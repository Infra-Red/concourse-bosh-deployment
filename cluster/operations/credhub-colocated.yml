# release
- type: replace
  path: /releases/-
  value:
    name: credhub
    url: https://bosh.io/d/github.com/pivotal-cf/credhub-release?v=((credhub_version))
    sha1: ((credhub_sha1))
    version: ((credhub_version))

# variables
- type: replace
  path: /variables?/name=credhub_db_password?
  value:
    name: credhub_db_password
    type: password
- type: replace
  path: /variables?/name=credhub_encryption_password?
  value:
    name: credhub_encryption_password
    type: password
    options:
      length: 40
- type: replace
  path: /variables?/name=concourse_to_credhub_client_secret?
  value:
    name: concourse_to_credhub_client_secret
    type: password
- type: replace
  path: /variables?/name=credhub_admin_secret?
  value:
    name: credhub_admin_secret
    type: password
- type: replace
  path: /variables?/name=uaa_jwt?
  value:
    name: uaa_jwt
    type: rsa
    options:
      key_length: 4096

# add credhub job to web instance group
- type: replace
  path: /instance_groups/name=web/jobs/-
  value:
    name: credhub
    release: credhub
    properties:
      credhub:
        port: 8844
        authentication:
          uaa:
            url: "((external_url)):8443"
            verification_key: ((uaa_jwt.public_key))
            enabled: true
            ca_certs:
            - ((atc_tls.ca))
        authorization:
          acls:
            enabled: false
        data_storage:
          type: postgres
          database: &credhub_db credhub
          username: &credhub_db_role credhub
          password: &credhub_db_passwd ((credhub_db_password))
          require_tls: false
        tls: ((atc_tls))
        log_level: info
        encryption:
          providers:
          - name: internal
            type: internal
          keys:
          - provider_name: internal
            key_properties:
              encryption_password: ((credhub_encryption_password))
            active: true

# update DB instance to include credhub databases
- type: replace
  path: /instance_groups/name=db/jobs/name=postgres/properties/databases/databases/-
  value:
    name: *credhub_db
- type: replace
  path: /instance_groups/name=db/jobs/name=postgres/properties/databases/roles/-
  value: 
    name: *credhub_db
    password: *credhub_db_passwd

# update UAA job by adding new client(s)
# concourse_to_credhub_client is used for concourse-credhub integration
- type: replace
  path: /instance_groups/name=web/jobs/name=uaa/properties/uaa/clients?/concourse_to_credhub_client
  value:
    id: concourse_to_credhub_client
    secret: ((concourse_to_credhub_client_secret))
    override: true
    authorized-grant-types: client_credentials
    scope: ""
    authorities: credhub.read,credhub.write
    access-token-validity: 1200
    refresh-token-validity: 3600
# credhub-admin is used as the CredHub Admin
- type: replace
  path: /instance_groups/name=web/jobs/name=uaa/properties/uaa/clients?/credhub-admin
  value:
    id: credhub-admin
    secret: ((credhub_admin_secret))
    override: true
    authorized-grant-types: client_credentials
    scope: ""
    authorities: credhub.read,credhub.write
    access-token-validity: 3600
    refresh-token-validity: 3600

# add credhub integration with atc job
- type: replace
  path: /instance_groups/name=web/jobs/name=atc/properties/credhub?
  value:
    url: ((external_url)):8844
    tls:
      ca_cert: ((atc_ca))
      insecure_skip_verify: false
    client_id: concourse_to_credhub_client
    client_secret: ((concourse_to_credhub_client_secret))